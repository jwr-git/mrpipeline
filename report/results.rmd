---
output:
  html_document:
    md_extensions: +raw_html
    toc: true
    toc_depth: 2
    toc_float: true
params:
  report: "report"
  dat: "dat"
  id.exposure: "id.exposure"
  trait.name: "trait.name"
  new_title: "Per-trait results"
title: "`r params$new_title`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

# Subset correct results for reporting
results <- params$report$results
results <- results[results$id.exposure == id.exposure, ]

cresults <- params$report$cresults
cresults <- cresults[cresults$id1 == id.exposure, ]

sensitivity <- params$report$sresults
sensitivity <- sensitivity[sensitivity$id.exposure == id.exposure, ]

plots <- params$report$plots
plots <- plots[plots$id1 == id.exposure, ]

# raw.plots have the same indices as plots
# therefore raw.plots can be subsetted the same as plots
raw.plots <- report$raw.plots
raw.plots <- raw.plots[as.integer(rownames(plots[plots$id1 == id.exposure, ]))]

# Now the df need re-indexed
rownames(plots) <- 1:nrow(plots)
```

<style type="text/css">
#TOC {
  left: 40px;
  margin: 20px 0px 25px 0px;
}

.main-container {
  max-width: 2400px;
  margin-left: 100px;
  margin-right: auto;
}

.imgTooltip {
      display: none;
}

.ItemsTooltip:hover .imgTooltip {
      display: block;
      position: absolute;
      z-index: 1;
}
</style>

# [Back to Main Page](./../report.html)

# Diagnostic Plots

```{r}
if (nrow(params$dat) < 3) {
  cat("No plots generated due to insufficient SNPs.")
}
```

`r if (nrow(params$dat) < 3) { "\\begin{comment}" }`

## Z score plot

A plot of Z score (beta / SE) against P value for each exposure SNP which can help detect potentially problematic SNPs. The shape of the graph should be parabolic, roughly of the form $y=x^{2}$, with potentially problematic SNPs lying outside of that curve. A curve of best fit is also provided as a rough aid if there are enough SNPs.

```{r f-plot, warning = F, dpi=300, fig.width=2, fig.height=2}
plotly::ggplotly(automrpipeline::interactive_z_plot(params$dat))
```
`r if (nrow(params$dat) < 3) { "\\end{comment}" }`

## Scatter plots {.tabset}

Scatter plots of the SNP-exposure and SNP-outcome effects to potentially detect problematic SNPs.

```{r scatter-plot, warning = F, results = "asis", dpi=300, fig.width=2, fig.height=2}
plotlist <- htmltools::tagList() # Work around for print and plotly::ggplotly not working nicely together
j <- 0
for (i in unique(dat$id.outcome)) {
  j <- j + 1
  p <- automrpipeline::interactive_scatter_plot(params$dat, params$id.exposure, i)
  if (!is.null(p)) {
    cat("  \n### ", unique(dat[dat$id.outcome == i,]$outcome), "  \n")
    plotlist[[j]] <- as.widget(plotly::ggplotly(p))
    print(htmltools::tagList(plotlist[[j]]))
    cat("  \n")
  } else {
    cat("No plot generated.")
  }
}
```

<!--
## SNP-Effects Forest plot
-->
# MR Results

Results for the main MR analyses (Wald ratio (WR) and inverse variance weighted (IVW)) are given here. The WR method is performed on single-SNP instruments, whilst the IVW method is performed on everything else.

```{r results-mr, message = F, warning = F, echo = F}
steiger <- params$report$steigerresults
steiger <- steiger[steiger$id.exposure == params$id.exposure,]

results %>%
  dplyr::left_join(steiger) %>%
  dplyr::rename(Exposure.ID = id.exposure,
                Outcome.ID = id.outcome,
                Outcome = outcome,
                Exposure = exposure,
                Method = method,
                SNPs = nsnp,
                P.value = pval,
                OR = or,
                Lower.95ci = or_lci95,
                Upper.95ci = or_uci95,
                r2.exposure = snp_r2.exposure,
                r2.outcome = snp_r2.outcome,
                Direction = correct_causal_direction,
                Steiger.P = steiger_pval,
                Steiger.Flag = flag) %>%
  dplyr::select(-Exposure.ID, -Outcome.ID) %>%
  dplyr::relocate(Outcome, .after = Exposure) %>%
  DT::datatable(rownames = F,
                filter = 'top',                
                extensions = 'Buttons',
                caption = "MR results for this exposure on all outcomes",
                options = list(order = list(5, "desc"), 
                               dom = 'Bfrtip',
                               buttons = list('copy',
                                              list(extend = 'collection', 
                                                   buttons = c('csv', 'excel'), 
                                                   text = 'Download')))) %>%
  DT::formatSignif(columns = c("P.value", 
                               "OR", 
                               "Lower.95ci", 
                               "Upper.95ci",
                               "r2.exposure",
                               "r2.outcome",
                               "Steiger.P"), 
                   digits = 3)
```

# Results Plots {.tabset}

Plots shown here include scatter and forest plots of results, if they are generated (some may require many SNPs).

## Volcano Plot {.tabset}
```{r volcano-plot, echo = F, message = F, warning = F, results = F}
raw.plots[as.integer(rownames(plots[plots$type == "volcano", ]))]
```

## PheWAS-like Plot {.tabset}
```{r phewas-plot, echo = F, message = F, warning = F, results = F}
raw.plots[as.integer(rownames(plots[plots$type == "phewas", ]))]
```
<!--
```{r scatter-plot2, echo = F, message = F, warning = F, results = "asis"}
if (!nrow(plots[plots$type == "scatter", ]) || all(is.na(plots[plots$type == "scatter", ]))) {
  cat("No plots generated.")
} else {
  for (idx in as.integer(rownames(plots[plots$type == "scatter", ])))
  {
    if (is.na(raw.plots[[idx]])) {
      next
    }
    
    cat("  \n## Scatter Plot (", plots[idx, 'id1'], "&", plots[idx, 'id2'], ")  \n")
    print(raw.plots[[idx]][[1]])
    cat("  \n")
  }
}
```
-->

# Colocalisation

Colocalisaton uses the coloc.abf function from the coloc R package. This section should be expanded to include conditional analyses and/or pwcoco, or other colocalisation methods.

`r if (!length(cresults) || nrow(cresults) < 1 || !length(cresults[cresults["nsnps"] > 50, ])) { "\\begin{comment}" }`

```{r regional-plot, echo = F, message = F, include = F, dev = 'png', fig.show = 'hide'}
if (length(plots[plots$type == "regional", ]) > 0) {
  for (idx in as.integer(rownames(plots[plots$type == "regional", ])))
  {
    if (all(is.na(raw.plots[[idx]]))) {
      next
    }
    grid.newpage()
    grid.draw(raw.plots[[idx]])
  }
}
```

```{r coloc-table}
for (i in 1:nrow(cresults)) {
    tryCatch({
      cresults[i, "plot"] <- sprintf("<a class='ItemsTooltip' target='_blank'><img class='imgTooltip' src='%s'/>Region</a>", knitr::image_uri(knitr::fig_chunk('regional-plot', 'png', i)))
    },
    error = function(e) {
      cresults[i, "plot"] <- "No plot"
    })
}
cresults <- cresults[cresults["nsnps"] > 50, ]

if (length(cresults) && nrow(cresults) > 0) {
  cresults %>%
    dplyr::rename(Exposure = name1,
                  Outcome = name2,
                  SNPs = nsnps,
                  ChrPos = chrpos,
                  Plot = plot) %>%
    dplyr::select(-id1, -id2) %>%
    dplyr::relocate(Plot, .after = Outcome) %>%
    DT::datatable(rownames = F,
                  escape = F,
                  filter = 'top',
                  extensions = c("Buttons"),
                  options = list(order = list(7, "desc"), 
                                 dom = "Bfrtip", 
                                 buttons = list('copy',
                                                list(extend = 'collection', 
                                                     buttons = c('csv', 'excel'), 
                                                     text = 'Download')))) %>%
    DT::formatPercentage(c("H0", "H1", "H2", "H3", "H4"), 2)
} else {
  cat("No colocalisation results were generated.")
}
```

`r if (!length(cresults) || nrow(cresults) < 1 || !length(cresults[cresults["nsnps"] > 50, ])) { "\\end{comment}" }`
