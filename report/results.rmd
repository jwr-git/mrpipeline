---
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
params:
  report: "report"
  id.exposure: "id.exposure"
  new_title: "Per-trait results"
title: "`r params$new_title`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

# Subset correct results for reporting
results <- params$report$results
results <- results[results$id.exposure == id.exposure, ]

cresults <- params$report$cresults
cresults <- cresults[cresults$id1 == id.exposure, ]

sensitivity <- report$sresults
sensitivity <- sensitivity[sensitivity$id.exposure == id.exposure, ]

plots <- report$plots
plots <- plots[plots$id1 == id.exposure, ]

# raw.plots have the same indices as plots
# therefore raw.plots can be subsetted the same as plots
raw.plots <- report$raw.plots
raw.plots <- raw.plots[as.integer(rownames(plots[plots$id1 == id.exposure, ]))]

# Now the df need re-indexed
rownames(plots) <- 1:nrow(plots)
```

# Back to Main Page
[Click to go back to the Main Page.](./../report.html)

# QC Graphs {.tabset}

This section contains plots which can be helpful at the QC stage.

## F-stat plot

A plot of Z-scores, or $\beta^{2}/SE^{2}$, against P value for each exposure SNP which can help detect potentially problematic SNPs. The shape of the graph should be parabolic, roughly of the form $y=x^{2}$, with potentially problematic SNPs lying outside of that curve. A curve of best fit is also provided as a rough aid if there are enough SNPs.

```{r f_plot, echo = F, message = F, warning = F, results = F}
raw.plots[as.integer(rownames(plots[plots$type == "f", ]))]
```

# MR Results {.tabset}

Results for the main MR analyses (Wald ratio (WR) and inverse variance weighted (IVW)) are given here. The WR method is performed on single-SNP instruments, whilst the IVW method is performed on everything else.

```{r results_mr}
dplyr::rename(results,
              Exposure.ID = id.exposure,
              Outcome.ID = id.outcome,
              Outcome = outcome,
              Exposure = exposure,
              Method = method,
              SNPs = nsnp,
              P.value = pval,
              OR = or,
              Lower.95ci = or_lci95,
              Upper.95ci = or_uci95) %>%
  dplyr::relocate(Outcome, .after = Exposure) %>%
  DT::datatable(options = list(order = list(7, "asc"))) %>%
  DT::formatSignif(columns = c("P.value", "OR", "Lower.95ci", "Upper.95ci"), digits = 3)
```

`r if (length(sensitivity) == 0) { "\\begin{comment}" }`
# Sensitivity Results {.tabset}

Results are presented here for Sensitivity analyses.
TODO Not yet added -- unsure if worthwhile as if using QTLs then most analyses should be instruments with few SNPs.

## Heterogeneity

## Horizontal Pleiotropy

## Leave-one-out Analyses

`r if (length(sensitivity) == 0) { "\\end{comment}" }`

# Results Plots {.tabset}

Plots shown here include scatter and forest plots of results, if they are generated (some may require many SNPs).

## Volcano Plot {.tabset}
```{r volcano_plot, echo = F, message = F, warning = F, results = F}
raw.plots[as.integer(rownames(plots[plots$type == "volcano", ]))]
```

## PheWAS-like Plot {.tabset}
```{r phewas_plot, echo = F, message = F, warning = F, results = F}
raw.plots[as.integer(rownames(plots[plots$type == "phewas", ]))]
```

```{r scatter_plot, echo = F, message = F, warning = F, results = "asis"}
if (!nrow(plots[plots$type == "scatter", ]) || all(is.na(plots[plots$type == "scatter", ]))) {
  cat("No plots generated.")
} else {
  for (idx in as.integer(rownames(plots[plots$type == "scatter", ])))
  {
    if (is.na(raw.plots[[idx]])) {
      next
    }
    
    cat("  \n## Scatter Plot (", plots[idx, 'id1'], "&", plots[idx, 'id2'], ")  \n")
    print(raw.plots[[idx]][[1]])
    cat("  \n")
  }
}
```


# Colocalisation

Colocalisaton uses the coloc.abf function from the coloc R package. This section should be expanded to include conditional analyses and/or pwcoco, or other colocalisation methods.

```{r coloc_table}
dplyr::rename(cresults,
              Exposure.ID = id1,
              Outcome.ID = id2,
              SNPs = nsnps,
              ChrPos = chrpos) %>%
  DT::datatable(rownames = F,
                extensions = c("Buttons"),
                options = list(dom = "Bfrtip", buttons = c("copy", "csv"))) %>%
  DT::formatPercentage(c("H0", "H1", "H2", "H3", "H4"), 2)
```

## Regional Plots {.tabset}

These are regional plots for the regions used in the colocalisation analysis. Regions to plot are decided naively from the "lead" SNP, i.e. the SNP with the lowest P value at the minute.

```{r regional_plot, echo = F, message = F, results = "asis"}
if (length(plots[plots$type == "regional", ]) == 0) {
  cat("No plots generated.")
} else {
  for (idx in as.integer(rownames(plots[plots$type == "regional", ])))
  {
    if (all(is.na(raw.plots[[idx]]))) {
      next
    }
    
    cat("  \n###", plots[idx, 'id1'], "&", plots[idx, 'id2'], "  \n")
    grid.newpage()
    grid.draw(raw.plots[[idx]])
    cat("  \n")
  }
}
```
